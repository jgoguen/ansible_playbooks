# {{ ansible_managed }}

{% for var in pf_variables %}
{% if pf_variables[var] != "" %}
{{ var }} = "{{ pf_variables[var] }}"
{% endif %}
{% endfor %}

table <martians> { \
	0.0.0.0/8 10.0.0.0/8 127.0.0.0/8 169.254.0.0/16 172.16.0.0/12 192.0.0.0/24 \
	192.0.2.0/24 192.88.99.0/24 192.168.0.0/16 198.18.0.0/15 198.51.100.0/24 \
	203.0.113.0/24 224.0.0.0/3 \
	::/128 ::/96 ::1/128 ::ffff:0:0/96 100::/64 2001:10::/28 2001:2::/48 \
	2001:db8::/32 3ffe::/16 fec0::/10 fc00::/7 \
}

{% for table in pf_tables %}
table <{{ table }}> { {{ pf_tables[table] | join(" ") }} }
{% endfor %}

set block-policy return
set skip on lo
set reassemble yes no-df
set loginterface egress

match in all scrub (no-df random-id reassemble tcp)
{% if roles["gw"] %}match out on egress inet from !(egress:network) to any nat-to (egress:0) static-port{% endif %}

# Port build user does not need network
block drop out log quick proto {tcp udp} user _pbuild

{% if roles["gw"] %}
block drop in quick on egress from <martians> to any
block drop out quick on egress from any to <martians>
{% endif %}

pass in log quick inet proto icmp to { ($if_lan) 224.0.0.0/8 }
pass in log quick inet6 proto icmp6 to { ($if_lan) ff02::1/16 fe80::/10 }

block return all
pass out on $if_lan from ($if_lan) to any

{% for rule in pf_rules %}
{{ rule }}
{% endfor %}
