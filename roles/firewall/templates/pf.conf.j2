# {{ ansible_managed }}

if_lan = "{{ pf_lan_interface }}"
{% for var in pf_variables %}
{% if pf_variables[var] != "" %}
{{ var }} = "{{ pf_variables[var] }}"
{% endif %}
{% endfor %}

table <martians> { \
	0.0.0.0/8 10.0.0.0/8 127.0.0.0/8 169.254.0.0/16 172.16.0.0/12 192.0.0.0/24 \
	192.0.2.0/24 192.88.99.0/24 192.168.0.0/16 198.18.0.0/15 198.51.100.0/24 \
	203.0.113.0/24 224.0.0.0/3 \
	::/128 ::/96 ::1/128 ::ffff:0:0/96 100::/64 2001:10::/28 2001:2::/48 \
	2001:db8::/32 3ffe::/16 fec0::/10 fc00::/7 \
}
table <dns> { {{ ((dns_servers | map("format_map", "{0}/32") | list) + (rad_config["dns"] | map("format_map", "{0}/128") | list)) | join(" ") }} }
table <ntp> { {{ (ntp_server_addresses | map("format_map", "{0}") | list) | join(" ") }} }

{% for table in pf_tables %}
table <{{ table }}> { {{ pf_tables[table] | join(" ") }} }
{% endfor %}

set block-policy return
set skip on lo
set reassemble yes no-df
set loginterface egress

match in all scrub (no-df random-id reassemble tcp)
{% if pf_sections.nat %}match out on egress inet from !(egress:network) to any nat-to (egress:0) static-port{% endif %}

# Port build user does not need network
block drop out log quick proto {tcp udp} user _pbuild

{% if pf_sections.block_martians %}
# Block non-routable addresses on egress
block drop in quick on egress from <martians> to any
block drop out quick on egress from any to <martians>
{% endif %}

# Control inbound traffic, permit outbound by default
block return all
pass out modulate state

# Allow DHCP and DHCPv6
pass in on egress inet proto udp from port bootps to port bootpc
pass in on egress inet6 proto udp from fe80::/10 port dhcpv6-server to fe80::/10 port dhcpv6-client no state

# Allow ICMP
pass in on egress inet proto icmp to (egress)
pass in on egress inet6 proto icmp6 to { (egress) ff02::1/16 fe80::/10 }

{% if pf_sections.nat %}
# When doing NAT, we also need to allow DHCP and ICMP on the LAN side
pass in on !egress inet proto icmp
pass in on !egress inet6 proto icmp6
pass in on !egress inet proto udp from port bootpc to port bootps
{% endif %}

{% if pf_sections.sshd %}
pass in on $if_lan proto tcp from ($if_lan:network) to ($if_lan) port 22 modulate state
{% endif %}

{% if pf_sections.httpd %}
pass in on egress proto tcp from any to (egress) port { 80 443 } modulate state
{% endif %}

include "/etc/pf.conf.local"
