---
# vim: filetype=ansible:syntax=yaml:ts=2:sts=2:sw=2:expandtab:autoindent:nospell

all:
  children:
    blinkenboxen:
      hosts:
        localhost:
      vars:
        user: 'jgoguen'
        unix_groups: []
        roles:
          db: false
          desktop: false
          devel: false
          dhcpd: false
          dns: false
          gw: false
          mqttd: false
          unifi: false
        certbot_hosts: []
        dyndns_hosts: []
        packages:
          install: []
          remove: []
          aur: []
          snap: []
          flatpak: []
        repos: []
        coprs: []
        networkmanager_config:
          main:
            plugins: keyfile
            dhcp: dhclient
            dns: 'systemd-resolved'
          connection:
            'ipv6.ip6-privacy': 2
            'wifi.cloned-mac-address': stable
          device:
            'wifi.scan-rand-mac-address': yes
        iptables_policies:
          INPUT: ACCEPT
          FORWARD: ACCEPT
          OUTPUT: ACCEPT
        iptables_rules:
          - action: insert
            rule_num: '1'
            chain: INPUT
            ip_version: ipv4
            ctstate: INVALID
            jump: DROP
          - action: insert
            rule_num: '1'
            chain: INPUT
            ip_version: ipv6
            ctstate: INVALID
            jump: DROP
          - action: insert
            rule_num: '2'
            chain: INPUT
            ip_version: ipv4
            in_interface: lo
            jump: ACCEPT
          - action: insert
            rule_num: '2'
            chain: INPUT
            ip_version: ipv6
            in_interface: lo
            jump: ACCEPT
          - action: insert
            rule_num: '3'
            chain: INPUT
            ip_version: ipv4
            protocol: icmp
            jump: ACCEPT
          - action: insert
            rule_num: '3'
            chain: INPUT
            ip_version: ipv6
            protocol: icmp
            jump: ACCEPT
          - action: append
            chain: INPUT
            ip_version: ipv4
            ctstate:
              - RELATED
              - ESTABLISHED
            jump: ACCEPT
          - action: append
            chain: INPUT
            ip_version: ipv6
            ctstate:
              - RELATED
              - ESTABLISHED
            jump: ACCEPT
          - action: append
            chain: INPUT
            ip_version: ipv4
            protocol: udp
            destination_port: '5353'
            jump: ACCEPT
          - action: append
            chain: INPUT
            ip_version: ipv6
            protocol: udp
            destination_port: '5353'
            jump: ACCEPT
          - action: append
            chain: INPUT
            ip_version: ipv4
            protocol: udp
            source_port: '67'
            destination_port: '68'
            jump: ACCEPT
        # Maps interface name to lines in the hostname.if(5) file
        bsd_interfaces: {}
        # Gateway definitions in /etc/mygate
        bsd_gateway: []
        pf_variables: {}
        # Maps table name to contents
        pf_tables: {}
        pf_rules: []
        services:
          start: []
          stop: []
        sysctls: []
        dhcpd_config:
          dns: []
          domain_name: ''
          lease:
            default: 86400
            max: 172800
          # subnets: []
          # base: e.g. 10.0.0.0
          # subnet: e.g. 255.255.255.0
          # router: e.g. 10.0.0.1
          # start: e.g. 10.0.0.100
          # end: e.g. 10.0.0.200
          # hosts: {}
          #  name: {}
          #    mac: 01:23:45:67:89:ab
          #    address: 10.0.0.10
          subnets: []
        rad_config:
          dns: []
          interface: ''
        dhcpcd_config:
          allowinterfaces: ''
          interfaces: {}
        doas_rules:
          - 'permit nopass setenv { FTPMODE PKG_CACHE PKG_PATH SM_PATH SSH_AUTH_SOCK DESTDIR DISTDIR FETCH_CMD FLAVOR GROUP MAKE MAKECONF MULTI_PACKAGES NOMAN OKAY_FILES OWNER PKG_DBDIR PKG_DESTDIR PKG_TMPDIR PORTSDIR RELEASEDIR SHARED_ONLY SUBPACKAGE WRKOBJDIR SUDO_PORT_V1 } :wsrc'
          - 'permit persist :wheel'
        sudo_config:
          defaults_flags:
            - '!visiblepw'
            - insults
            - always_set_home
            - match_group_by_gid
            - env_reset
            - always_query_group_plugin
          defaults:
            env_keep:
              - '__CF_USER_TEXT_ENCODING'
              - BLOCKSIZE
              - CHARSET
              - COLORFGBG
              - COLORS
              - COLORTERM
              - DISPLAY
              - EDITOR
              - HOSTNAME
              - HISTSIZE
              - LANG
              - LANGUAGE
              - LC_ADDRESS
              - LC_ALL
              - LC_COLLATE
              - LC_CTYPE
              - LC_IDENTIFICATION
              - LC_MEASUREMENT
              - LC_MESSAGES
              - LC_MONETARY
              - LC_NAME
              - LC_NUMERIC
              - LC_PAPER
              - LC_TELEPHONE
              - LC_TIME
              - LINES_COLUMNS
              - LS_COLORS
              - LSCOLORS
              - MAIL
              - QTDIR
              - KDEDIR
              - SSH_AUTH_SOCK
              - TZ
              - USERNAME
              - VISUAL
              - XAUTHORITY
              - XAUTHORIZATION
            editor: '/usr/bin/nvim:/usr/local/bin/nvim:/usr/bin/vim:/usr/bin/vi:/bin/vi'
            secure_path: '/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
          users:
            - username: root
              from: ALL
              as_user: ALL
              commands:
                passwd:
                  - ALL
            - username: '%{{ ansible_local.root_owner.sudo }}'
              from: ALL
              as_user: ALL
              commands:
                passwd:
                  - ALL
        macos_defaults:
          '/Library/Preferences/com.apple.alf':
            # Do not automatically allow signed software to accept incoming connections
            - key: allowsignedenabled
              type: int
              value: 0
              become: no
          '/Library/Preferences/com.apple.loginwindow':
            - key: AdminHostInfo
              type: string
              value: HostName
              become: no

          NSGlobalDomain:
            - key: AppleActionOnDoubleClick
              type: string
              value: Minimize
            - key: AppleEnableSwipeNavigateWithScrolls
              type: bool
              value: true
            # Enble sub-pixel font rendering on non-Apple LCDs
            - key: AppleFontSmoothing
              type: int
              value: 1
            - key: AppleICUForce24HourTime
              type: bool
              value: true
            # Enable full keyboard access for all controls
            # (e.g. enable Tab in modal dialogs)
            - key: AppleKeyboardUIMode
              type: int
              value: 3
            # Disable press-and-hold in favour of key repeat
            - key: ApplePressAndHoldEnabled
              type: bool
              value: false
            - key: AppleTemperatureUnit
              type: string
              value: Fahrenheit
            - key: AppleWindowTabbingMode
              type: string
              value: always
            # Enable sub-pixel antialiasing
            - key: CGFontRenderingFontSmoothingDisabled
              type: bool
              value: false
            - key: com.apple.mouse.tapBehavior
              type: int
              value: 1
            # Set a fast initial key repeat
            - key: InitialKeyRepeat
              type: int
              value: 10
            # Set a fast key repeat
            - key: KeyRepeat
              type: int
              value: 3
            - key: NSAutomaticDashSubstitutionEnabled
              type: bool
              value: false
            - key: NSAutomaticQuoteSubstitutionEnabled
              type: bool
              value: false
            - key: NSDocumentSaveNewDocumentsToCloud
              type: bool
              value: false
            - key: NSNavPanelExpandedStateForSaveMode
              type: bool
              value: true
            - key: NSNavPanelExpandedStateForSaveMode2
              type: bool
              value: true
            # Disable that annoying "rubber band" scrolling
            - key: NSScrollViewRubberbanding
              type: bool
              value: true
            - key: NSTextShowsControlCharacters
              type: bool
              value: true
            - key: NSWindowResizeTime
              type: float
              value: 0.001
            - key: PMPrintingExpandedStateForPrint
              type: bool
              value: true
            - key: PMPrintingExpandedStateForPrint2
              type: bool
              value: true
            # Enable Safari Develop menu and Web Inspector
            - key: WebKitDeveloperExtras
              type: bool
              value: true

          'com.agilebits.onepassword7':
            - key: KeepHelperRunning
              type: bool
              value: true
            - key: ShowCopyUUIDItemMenu
              type: bool
              value: true

          # Show all processes in Activity Monitor, sort by CPU usage
          'com.apple.ActivityMonitor':
            - key: ShowCategory
              type: int
              value: 100
            - key: SortColumn
              type: string
              value: CPUUsage
            - key: SortDirection
              type: int
              value: 0

          'com.apple.AppleMultitouchTrackpad':
            - key: ActuateDetents
              type: int
              value: 1
            - key: Clicking
              type: bool
              value: true
            - key: Dragging
              type: int
              value: 1
            - key: ForceSuppressed
              type: bool
              value: false
            - key: TrackpadFiveFingerPinchGesture
              type: int
              value: 2
            - key: TrackpadFourFingerHorizSwipeGesture
              type: int
              value: 2
            - key: TrackpadFourFingerPinchGesture
              type: int
              value: 2
            - key: TrackpadPinch
              type: bool
              value: true
            - key: TrackpadRightClick
              type: bool
              value: true
            - key: TrackpadRotate
              type: bool
              value: true
            - key: TrackpadThreeFingerHorizSwipeGesture
              type: int
              value: 2
            - key: TrackpadTwoFingerDoubleTapGesture
              type: int
              value: 1
            - key: TrackpadTwoFingerFromRightEdgeSwipeGesture
              type: int
              value: 3

          'com.apple.BluetoothAudioAgent':
            # Increase sound quality for Bluetooth headphones
            - key: 'Apple Bitpool Min (editable)'
              type: int
              value: 40

          'com.apple.commerce':
            - key: AutoUpdate
              type: bool
              value: true

          'com.apple.controlstrip':
            - key: FullCustomized
              type: array
              value:
                - 'com.apple.system.group.brightness'
                - 'com.apple.system.group.keyboard-brightness'
                - 'com.apple.system.airplay'
                - 'com.apple.system.group.media'
                - 'com.apple.system.screen-lock'
                - 'com.apple.system.group.volume'
                - 'com.apple.system.siri'
            - key: MiniCustomized
              type: array
              value:
                - 'com.apple.system.brightness'
                - 'com.apple.system.volume'
                - 'com.apple.system.mute'
                - 'com.apple.system.screen-lock'

          'com.apple.desktopservices':
            # Don't write .DS_Store files on network drives
            - key: DSDontWriteNetworkStores
              type: bool
              value: true
            # Don't write .DS_Store files on USB drives
            - key: DSDontWriteUSBStores
              type: bool
              value: true

          'com.apple.dock':
            # Always show the Dock
            - key: autohide
              type: bool
              value: false
            # Remove the auto-hiding Dock delay
            - key: autohide-delay
              type: float
              value: 0
            # Don’t automatically rearrange Spaces based on most recent use
            - key: mru-spaces
              type: bool
              value: false
            - key: showAppExposeGestureEnabled
              type: bool
              value: true
            # Do not show recently used apps
            - key: show-recents
              type: bool
              value: false
            # Bottom-left corner starts screensaver
            - key: wvous-bl-corner
              type: int
              value: 13
            - key: wvous-bl-modifier
              type: int
              value: 0

          'com.apple.driver.AppleBluetoothMultitouch.trackpad':
            - key: Clicking
              type: bool
              value: true
            - key: Dragging
              type: int
              value: 1
            - key: TrackpadFiveFingerPinchGesture
              type: int
              value: 2
            - key: TrackpadFourFingerHorizSwipeGesture
              type: int
              value: 2
            - key: TrackpadFourFingerPinchGesture
              type: int
              value: 2
            - key: TrackpadPinch
              type: bool
              value: true
            - key: TrackpadRightClick
              type: bool
              value: true
            - key: TrackpadRotate
              type: bool
              value: true
            - key: TrackpadThreeFingerHorizSwipeGesture
              type: int
              value: 2
            - key: TrackpadTwoFingerDoubleTapGesture
              type: int
              value: 1
            - key: TrackpadTwoFingerFromRightEdgeSwipeGesture
              type: int
              value: 3

          'com.apple.finder':
            # Show POSIX path as Finder title
            - key: _FXShowPosixPathInTitle
              type: bool
              value: true
            # Keep folders on top when sorting by name
            - key: '_FXSortFoldersFirst'
              type: bool
              value: true
            # Use icon view in all Finder windows by default
            # Four-letter codes for the other view modes:
            # - List view: `Nlsv`
            # - Icon view: `icnv`
            # - Column view: `clmv`
            # - Gallery view: `glyv`
            - key: FXPreferredViewStyle
              type: string
              value: icnv
            - key: QLEnableTextSelection
              type: bool
              value: true
            - key: ShowExternalHardDrivesOnDesktop
              type: bool
              value: true
            - key: ShowHardDrivesOnDesktop
              type: bool
              value: false
            - key: ShowMountedServersOnDesktop
              type: bool
              value: true
            - key: ShowRemovableMediaOnDesktop
              type: bool
              value: true

          'com.apple.mail':
            - key: DisableInlineAttachmentViewing
              type: bool
              value: true

          'com.apple.menuextra.battery':
            - key: ShowPercent
              type: string
              value: YES

          'com.apple.menuextra.clock':
            - key: DateFormat
              type: string
              value: 'EEE d MMM  H:mm:ss'
            - key: FlashDateSeparators
              type: bool
              value: false
            - key: IsAnalog
              type: bool
              value: false

          'com.apple.print.PrintingPrefs':
            - key: 'Quit When Finished'
              type: bool
              value: true

          'com.apple.Safari':
            # Enable Develop menu and Web Inspector
            - key: 'com.apple.Safari.ContentPageGroupIdentifier.WebKit2DeveloperExtrasEnabled'
              type: bool
              value: true
            - key: IncludeDevelopMenu
              type: bool
              value: true
            - key: IncludeInternalDebugMenu
              type: bool
              value: true
            - key: WebKitDeveloperExtrasEnabledPreferenceKey
              type: bool
              value: true

          'com.apple.screensaver':
            - key: askForPassword
              type: int
              value: 1
            - key: askForPasswordDelay
              type: int
              value: 0

          # App Store: autoupdate, check daily, install critical updates
          'com.apple.SoftwareUpdate':
            - key: AutomaticCheckEnabled
              type: bool
              value: true
            - key: ScheduleFrequency
              type: int
              value: 1
            - key: CriticalUpdateInstall
              type: int
              value: 1

          'com.apple.Terminal':
            # Secure keyboard entry in Terminal.app
            - key: SecureKeyboardEntry
              type: bool
              value: true

          'com.apple.TextEdit':
            - key: PlainTextEncoding
              type: int
              value: 4
            - key: PlainTextEncodingForWrite
              type: int
              value: 4
            # Default to plain text
            - key: RichText
              type: int
              value: 0

          'com.apple.TimeMachine':
            # Time Machine: don't offer to use new disks
            - key: DoNotOfferNewDisksForBackup
              type: bool
              value: true
              become: yes

          'com.google.Chrome':
            - key: PMPrintingExpandedStateForPrint2
              type: bool
              value: true

          'com.googlecode.iterm2':
            # Don't prompt on quit in iTerm
            - key: PromptOnQuit
              type: bool
              value: false
            # Secure keyboard entry in iTerm
            - key: 'Secure Input'
              type: bool
              value: true
        unbound_config:
          server:
            include:
              - /var/unbound/etc/unbound.conf.d/adblock.conf
              - /var/unbound/etc/unbound.conf.d/access-control.conf
              - /var/unbound/etc/unbound.conf.d/private-lan.conf
            interface:
              - '127.0.0.1'
              - '::1'
            hide-identity: 'yes'
            hide-version: 'yes'
            auto-trust-anchor-file: '"/var/unbound/db/root.key"'
            val-log-level: '2'
            aggressive-nsec: 'yes'
            tls-cert-bundle: '"/etc/ssl/cert.pem"'
          remote-control:
            control-enable: 'yes'
            control-interface: /var/run/unbound.sock
          include:
            - /var/unbound/etc/unbound.conf.d/forward-zone.conf
          # auth-zone is special, it is an array of name/zonefile pairings. Each
          # one needs to be its own auth-zone stanza in unbound.conf
          auth-zone: []
        dns_servers: []
        ntp_servers:
          - time1.facebook.com
          - time2.facebook.com
          - time3.facebook.com
          - time4.facebook.com
          - time5.facebook.com
        psql_conf:
          listen_addresses: "'*'"
          password_encryption: "'scram-sha-256'"
          max_connections: '100'
          ssl: 'off'
          ssl_cert_file: "'/etc/ssl/{{ ansible_fqdn }}/fullchain.pem'"
          ssl_key_file: "'/etc/ssl/{{ ansible_fqdn }}/privkey.pem'"
          shared_buffers: '512MB'
          dynamic_shared_memory_type: 'posix'
          min_wal_size: '80MB'
          max_wal_size: '1GB'
          log_timezone: "'America/Los_Angeles'"
          timezone: "'America/Los_Angeles'"
        homeassistant_vars:
          ip: ''
          webhooks: {}
